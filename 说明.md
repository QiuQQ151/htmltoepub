# HTML转EPUB工具 - 项目文档

## 项目概述
一个将HTML网页新闻转换为EPUB电子书的工具，支持自动抓取、内容提取和EPUB打包功能。

### 主要功能
- 网页新闻抓取与内容提取
- 多源支持（新华日报、南方日报）
- 自动生成EPUB电子书
- 支持自定义日期抓取
- 进度显示和日志记录

### 技术栈
- **语言**: C语言
- **依赖库**: libcurl, libfreetype, libjpeg
- **构建工具**: GCC, Make
- **脚本**: Bash

## 快速开始

### 安装依赖
```bash
sudo apt install -y \
  gcc \
  make \
  build-essential \
  libcurl4-openssl-dev \
  libfreetype6-dev \
  libjpeg-dev
```

### 编译项目
```bash
gcc -g main.c ./lib/epub.c ./lib/extract.c ./lib/xhrb.c ./lib/nfrb.c ./lib/mkjpg.c \
  -o html2epub.exe -lcurl -I/usr/include/freetype2 -lfreetype -ljpeg
```

### 使用方法
```bash
# 1. 默认抓取最新日期
./html2epub.sh

# 2. 指定日期抓取
./html2epub.exe 20241024
```

## 项目结构

```
htmltoepub/
├── README.md              # 项目说明文档
├── main.c                 # 主程序入口
├── html2epub.sh          # 主执行脚本
├── html2epub.exe         # 可执行文件
├── history/              # 历史文件存档
├── temp/                 # 临时工作目录
└── lib/                  # 核心库文件
    ├── head.h            # 头文件汇总
    ├── extract.[ch]      # HTML提取工具
    ├── epub.[ch]         # EPUB生成模块
    ├── mkjpg.[ch]        # 封面图片生成
    ├── xhrb.[ch]         # 新华日报抓取器
    ├── nfrb.[ch]         # 南方日报抓取器
    ├── mimetype          # EPUB MIME类型定义
    ├── container.xml     # EPUB容器配置
    ├── cover.jpg         # 默认封面（新华日报）
    └── kedaya.jpg        # 南方日报封面
```

## 核心模块说明

### 1. 主程序 (main.c)
- 程序入口点
- 参数解析（日期处理）
- 日志文件初始化
- 调度各抓取模块

### 2. 执行脚本 (html2epub.sh)
- 目录结构初始化
- 历史文件管理
- EPUB打包流程
- 进度显示功能

### 3. EPUB生成模块 (lib/epub.[ch])
- EPUB文件结构创建
- 章节内容组织
- 资源文件管理
- 内存泄漏修复（2026/1/28）

### 4. HTML提取模块 (lib/extract.[ch])
- 通用HTML解析工具
- 正则表达式匹配
- 内容清洗和格式化

### 5. 抓取器模块
- **新华日报抓取器 (lib/xhrb.[ch])**: 针对新华日报网站的结构化抓取
- **南方日报抓取器 (lib/nfrb.[ch])**: 针对南方日报网站的结构化抓取

### 6. 封面生成模块 (lib/mkjpg.[ch])
- 动态封面图片生成
- 字体渲染支持
- 日期信息合成

## 数据格式规范

### 生成的TXT文件格式
```
（可选说明）
每日新闻        
日期：202410/25   
制作：QQQ

（正文）
<图片:n>                    # 无图标记
1<标题:文章标题>            # 文章编号和标题
文章正文内容...             # 正文内容（含换行符）
<end>                      # 文章结束标记

<图片:2.jpg>                # 有图标记
2<标题:另一篇文章>
文章内容...
<end>
```

### EPUB文件结构
```
epub/
├── mimetype
├── META-INF/
│   └── container.xml
└── OEBPS/
    ├── content.opf
    ├── toc.ncx
    ├── cover.jpg
    ├── images/
    └── chapter*.xhtml
```

## 开发指南

### 添加新的新闻源
1. 在 `lib/` 目录下创建新的抓取器文件（如 `newspaper.c` 和 `newspaper.h`）
2. 实现抓取函数，遵循现有的接口规范
3. 在 `lib/head.h` 中添加头文件引用
4. 在 `main.c` 中调用新的抓取函数
5. 在 `html2epub.sh` 中添加对应的目录处理逻辑

### 代码规范
- 使用有意义的变量和函数名
- 添加必要的注释说明
- 确保内存正确分配和释放
- 错误处理要完善

## 已知问题和解决方案

### 1. EPUB封面缺少日期
**问题**: 封面中合成的日期字符显示异常
**原因**: 系统字体库路径问题
**解决方案**: 
- 检查 `lib/mkjpg.c` 中定义的字体路径
- 安装缺失的字体或修改为可用字体路径

### 2. 内存泄漏问题（已修复 - 2026/1/28）
**修复内容**:
- `content_opf_create`: 添加 `location` 内存释放
- `toc_ncx_create`: 添加 `location` 和 `num_Order` 内存释放
- `chapter_create`: 添加循环中临时内存释放
- `index_create`: 添加 `location` 内存释放
- `buil_article_list`: 修复 `sizeof` 使用错误，添加 `article_num` 内存释放

## 性能优化建议

### 1. 并行处理
- 考虑使用多线程同时处理多个新闻源
- 异步下载图片资源

### 2. 缓存机制
- 实现已抓取内容的本地缓存
- 减少重复网络请求

### 3. 错误恢复
- 添加断点续传功能
- 网络异常时的重试机制

## 测试和验证

### 单元测试
```bash
# 编译测试程序
gcc -g test_extract.c ./lib/extract.c -o test_extract -lcurl

# 运行测试
./test_extract
```

### 集成测试
1. 运行完整流程：`./html2epub.sh`
2. 检查生成的EPUB文件结构
3. 验证内容完整性和格式正确性

## 版本历史

### v1.0.0 (当前)
- 基础功能实现
- 支持新华日报和南方日报
- EPUB生成和打包
- 内存泄漏修复

### 待开发功能
- [ ] 支持更多新闻源
- [ ] 配置文件支持
- [ ] 定时自动抓取
- [ ] EPUB样式自定义

## 联系方式
- 项目维护者: QQQ
- 问题反馈: 通过GitHub Issues提交

---

*最后更新: 2026年1月28日*